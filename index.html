<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internal Quotation System</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!   <!-- Remove SQLite loading scripts and replace with IndexedDB support -->
    <script>
        // Check if IndexedDB is supported
        if (!window.indexedDB) {
            console.error('IndexedDB is not supported in this browser');
            alert('Your browser does not support IndexedDB. Please use a modern browser.');
        } else {
            console.log('IndexedDB is supported');
        }
    </script>
            document.head.appendChild(script);
        }
    </script>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <h1>Internal Quotation System</h1>
            <div class="login-form">
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="username" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="password" placeholder="Enter password">
                </div>
                <button onclick="login()" class="btn-primary">Login</button>
                <button onclick="resetSystem()" class="btn-secondary" style="margin-top: 10px;">Reset System</button>
            </div>
        </div>
    </div>

    <!-- Custom Modal Dialog -->
    <div id="customModal" class="custom-modal" style="display: none; visibility: hidden; opacity: 0;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">提示</h3>
            </div>
            <div class="modal-body">
                <div id="modalMessage"></div>
                <div class="modal-actions">
                    <button id="modalConfirmBtn" class="btn-primary">确认</button>
                    <button id="modalCancelBtn" class="btn-secondary">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Frontend -->
    <div id="salesFrontend" class="main-app" style="display: none;">
        <div class="container">
            <!-- Header -->
            <header>
                <div class="header-top">
                    <h1>Sales Dashboard</h1>
                    <div class="user-info">
                        <span id="currentUser"></span>
                        <button onclick="logout()" class="btn-logout">Logout</button>
                    </div>
                </div>
                <div class="header-controls">
                    <button onclick="showTab('quotation')" class="tab-btn active">New Quotation</button>
                    <button onclick="showTab('myQuotations')" class="tab-btn">My Quotations</button>
                    <button onclick="showTab('myCustomers')" class="tab-btn">My Customers</button>
                </div>
            </header>



            <!-- New Quotation -->
            <div id="quotation" class="tab-content active">
                <div class="card">
                    <h2>New Quotation</h2>
                    
                    <!-- Company Information -->
                    <div class="company-info">
                        <h3>Company Information</h3>
                        <div class="form-row">
                                                    <div class="form-group">
                            <label>Company Name:</label>
                            <input type="text" id="companyName" placeholder="Company name">
                        </div>
                        <div class="form-group">
                            <label>Phone Number:</label>
                            <input type="text" id="companyPhone" placeholder="Phone number">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address:</label>
                        <input type="text" id="companyAddress" placeholder="Company address">
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="companyEmail" placeholder="Company email">
                    </div>
                    </div>

                    <!-- Quotation Details -->
                    <div class="quotation-details">
                        <h3>Quotation Details</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Quotation Number:</label>
                                <input type="text" id="quotationNumber" placeholder="QUO-00123">
                            </div>
                            <div class="form-group">
                                <label>Quotation Date:</label>
                                <input type="date" id="quotationDate">
                            </div>
                            <div class="form-group">
                                <label>Valid Until:</label>
                                <input type="date" id="validUntil">
                            </div>
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div class="customer-info">
                        <h3>Customer Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Full Name:</label>
                                <input type="text" id="customerName" placeholder="Customer full name">
                            </div>
                            <div class="form-group">
                                <label>Phone Number:</label>
                                <input type="text" id="customerPhone" placeholder="Customer phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email Address:</label>
                            <input type="email" id="customerEmail" placeholder="Customer email address">
                        </div>
                        <div class="form-group">
                            <label>Delivery Address:</label>
                            <input type="text" id="customerAddress" placeholder="Street address">
                            <div class="form-row">
                                <div class="form-group">
                                    <input type="text" id="customerCity" placeholder="City">
                                </div>
                                <div class="form-group">
                                    <input type="text" id="customerState" placeholder="State">
                                </div>
                                <div class="form-group">
                                    <input type="text" id="customerZip" placeholder="ZIP Code">
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Order Summary -->
                    <div class="order-summary">
                        <h3>Order Summary</h3>
                        <div class="summary-table-container">
                            <table class="summary-table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>System</th>
                                        <th>Product Code 1</th>
                                        <th>Product Code 2</th>
                                        <th>Width</th>
                                        <th>Length</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Total Price</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="productList">
                                    <!-- Dynamically generated rows -->
                                </tbody>
                            </table>
                        </div>
                        <button onclick="addProductItem()" class="btn-secondary add-product-btn">+ Add Product</button>
                    </div>

                    <!-- Special Instructions -->
                    <div class="special-instructions">
                        <h3>Special Instructions or Requests</h3>
                        <div class="form-group">
                            <textarea id="specialInstructions" placeholder="Special instructions provided by the customer" rows="3"></textarea>
                        </div>
                        <div class="promotion-info" id="promotionInfo" style="display: none;">
                            <h4>Active Promotions</h4>
                            <div id="activePromotionsList"></div>
                        </div>
                    </div>

                    <!-- Payment Information -->
                    <div class="payment-info">
                        <h3>Payment Information</h3>
                        <div class="payment-summary">
                            <div class="summary-row">
                                <label>Subtotal:</label>
                                <span id="subtotal">$0.00</span>
                            </div>
                            <div class="summary-row" id="discountRow" style="display: none;">
                                <label>Current Discount (%):</label>
                                <span id="currentDiscount">0%</span>
                            </div>
                            <div class="summary-row" id="discountAmountRow" style="display: none;">
                                <label>Discount Amount:</label>
                                <span id="discountAmount">$0.00</span>
                            </div>
                            <div class="summary-row">
                                <label>Tax Rate (%):</label>
                                <input type="number" id="taxRate" value="8" min="0" max="100" step="0.1">
                            </div>
                            <div class="summary-row">
                                <label>Tax Amount:</label>
                                <span id="taxAmount">$0.00</span>
                            </div>
                            <div class="summary-row">
                                <label>Shipping Fee:</label>
                                <div class="currency-input">
                                    <span class="currency-symbol">$</span>
                                    <input type="number" id="shippingFee" value="10" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="summary-row total">
                                <label>Total Amount Due:</label>
                                <span id="totalAmount">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="payment-method">
                        <h3>Payment Method</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Payment Method:</label>
                                <select id="paymentMethod">
                                    <option value="">Select payment method</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <option value="check">Check</option>
                                    <option value="credit_card">Credit Card</option>
                                    <option value="cash">Cash</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Billing Address:</label>
                                <input type="text" id="billingAddress" placeholder="If different from delivery address, specify: Street, City, State, Zip Code">
                            </div>
                        </div>
                    </div>



                    <!-- Terms and Conditions -->
                    <div class="terms-conditions">
                        <h3>Terms and Conditions</h3>
                        <div class="terms-content">
                            <ul>
                                <li>All sales are final.</li>
                                <li>Products are covered under a one-year warranty for manufacturing defects.</li>
                                <li>Please refer to our return policy for more information.</li>
                                <li>Payment is due within 30 days of quotation date.</li>
                                <li>Prices are subject to change without prior notice.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="notes">
                        <h3>Notes</h3>
                        <div class="notes-content">
                            <ul>
                                <li>Please make the payment by the due date to avoid any late fees.</li>
                                <li>If you have any questions about this quotation, please contact us at the phone number or email above.</li>
                                <li>This quotation is valid for 30 days from the date of issue.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Closing Statement -->
                    <div class="closing-statement">
                        <h3>Thank you for your business!</h3>
                    </div>

                    <div class="action-buttons">
                        <button onclick="saveQuotation()" class="btn-primary">Save Quotation</button>
                        <button onclick="exportPDF()" class="btn-secondary">Export PDF</button>
                        <button onclick="exportExcel()" class="btn-secondary">Export Excel</button>
                        <button onclick="printQuotation()" class="btn-secondary">Print</button>
                    </div>
                </div>
            </div>

            <!-- My Quotations -->
            <div id="myQuotations" class="tab-content">
                <div class="card">
                    <h2>My Quotations</h2>
                    <div id="quotationsList"></div>
                </div>
            </div>

            <!-- My Customers -->
            <div id="myCustomers" class="tab-content">
                <div class="card">
                    <h2>My Customers</h2>
                    <div id="customersList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Backend -->
    <div id="adminBackend" class="main-app" style="display: none;">
        <div class="container">
            <!-- Header -->
            <header>
                <div class="header-top">
                    <h1>Admin Backend</h1>
                    <div class="user-info">
                        <span id="adminUser"></span>
                        <button onclick="logout()" class="btn-logout">Logout</button>
                    </div>
                </div>
                <div class="header-controls">
                    <button onclick="showAdminTab('pricing')" class="tab-btn active">Price List Management</button>
                    <button onclick="showAdminTab('promotions')" class="tab-btn">Promotion Design</button>
                    <button onclick="showAdminTab('users')" class="tab-btn">User Management</button>
                    <button onclick="showAdminTab('quotations')" class="tab-btn">Quotation Management</button>
                    <button onclick="showAdminTab('backup')" class="tab-btn">数据备份</button>
                    <button onclick="showAdminTab('system')" class="tab-btn">System Settings</button>
                </div>
            </header>



            <!-- Price List Management -->
            <div id="pricing" class="admin-tab-content active">
                <div class="card">
                    <h2>Price List Management</h2>
                    
                    <!-- 数据库配置 -->
                    <div class="database-config">
                        <h4>Database Configuration</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Database Type:</label>
                                <select id="dbType" onchange="toggleDatabaseConfig()">
                                    <option value="sqlite">SQLite (Local)</option>
                                    <option value="api">Remote API</option>
                                    <option value="indexeddb">IndexedDB</option>
                                </select>
                            </div>
                            <div class="form-group" id="apiUrlGroup" style="display: none;">
                                <label>API Base URL:</label>
                                <input type="url" id="apiBaseUrl" placeholder="http://localhost:3000/api" value="http://localhost:3000/api">
                            </div>
                            <div class="form-group" id="apiAuthGroup" style="display: none;">
                                <label>API Key:</label>
                                <input type="text" id="apiKey" placeholder="Enter API key if required">
                            </div>
                        </div>
                        <button onclick="saveDatabaseConfig()" class="btn-primary">Save Database Config</button>
                        <button onclick="testDatabaseConnection()" class="btn-secondary">Test Connection</button>
                    </div>

                    <!-- 数据源配置 -->
                    <div class="data-source-config">
                        <h4>数据源配置</h4>
                        
                        <!-- 数据源类型选择 -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>数据源类型:</label>
                                <select id="dataSourceType" onchange="toggleDataSourceConfig()">
                                    <option value="local">本地文件</option>
                                    <option value="remote">远程服务器</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- 本地文件配置 -->
                        <div id="localFileConfig" class="config-section">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>选择文件:</label>
                                    <div class="file-selector">
                                        <input type="file" id="mainFileInput" accept=".xlsx,.xls,.csv" onchange="handleFileSelection(this)">
                                        <button type="button" onclick="clearFileSelection()" class="btn-danger" id="clearFileBtn" style="display: none;">清除文件</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 文件信息显示 -->
                            <div id="fileInfo" class="file-info" style="display: none;">
                                <div class="file-details">
                                    <p><strong>文件名:</strong> <span id="fileName"></span></p>
                                    <p><strong>文件大小:</strong> <span id="fileSize"></span></p>
                                    <p><strong>文件类型:</strong> <span id="fileType"></span></p>
                                </div>
                            </div>
                            
                            <!-- 文件配置选项 -->
                            <div id="fileConfigOptions" class="config-options" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>文件格式:</label>
                                        <select id="fileFormat">
                                            <option value="xlsx">Excel (.xlsx)</option>
                                            <option value="xls">Excel (.xls)</option>
                                            <option value="csv">CSV (.csv)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>工作表名称 (Excel):</label>
                                        <input type="text" id="sheetName" placeholder="Sheet1" value="Sheet1">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 远程服务器配置 -->
                        <div id="remoteServerConfig" class="config-section" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>服务器地址:</label>
                                    <input type="url" id="remoteUrl" placeholder="https://example.com/api/prices">
                                </div>
                            </div>
                        </div>
                        
                        <!-- 操作按钮 -->
                        <div class="action-buttons">
                            <button onclick="saveDataSourceConfig()" class="btn-primary">保存配置</button>
                            <button class="btn-secondary" id="importBtn" disabled>导入数据</button>
                        </div>
                    </div>

                    <!-- 数据库管理 -->
                    <div class="database-management">
                        <h4>数据库管理</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <button onclick="clearDatabase()" class="btn-danger">清空数据库</button>
                                <button onclick="recreateDatabaseTables()" class="btn-warning">重新创建表</button>
                                <button onclick="refreshDatabaseStatus()" class="btn-secondary">刷新状态</button>
                                <button onclick="checkDatabaseData()" class="btn-info">检查数据</button>
                            </div>
                        </div>
                    </div>

                    <!-- 数据库状态 -->
                    <div class="database-status">
                        <h4>数据库状态</h4>
                        <div class="status-info">
                            <p><strong>数据库类型:</strong> <span id="dbStatusType">未初始化</span></p>
                            <p><strong>总记录数:</strong> <span id="dbRecordCount">0</span></p>
                            <p><strong>产品类别数:</strong> <span id="dbCategoryCount">0</span></p>
                            <p><strong>最后同步:</strong> <span id="dbLastSync">从未</span></p>
                        </div>
                    </div>

                    <!-- 价目表显示 -->
                    <div id="priceTableDisplay"></div>
                </div>
            </div>

            <!-- Promotion Design -->
            <div id="promotions" class="admin-tab-content">
                <div class="card">
                    <h2>Promotion Design</h2>
                    <div class="promotion-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Promotion Name:</label>
                                <input type="text" id="promotionName" placeholder="Enter promotion name">
                            </div>
                            <div class="form-group">
                                <label>Category:</label>
                                <select id="promotionCategory">
                                    <option value="">选择产品类别</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>System:</label>
                                <select id="promotionSystem">
                                    <option value="">选择产品系统</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Product Code:</label>
                                <input type="text" id="promotionCode" placeholder="输入或选择产品代码" list="productCodes">
                            </div>
                            <div class="form-group">
                                <label>Size Category:</label>
                                <select id="promotionSizeCategory">
                                    <option value="small">Small (≤100 cm²)</option>
                                    <option value="medium">Medium (≤500 cm²)</option>
                                    <option value="large">Large (≤1000 cm²)</option>
                                    <option value="extra-large">Extra Large (>1000 cm²)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Discount (%):</label>
                                <input type="number" id="promotionDiscount" placeholder="Discount percentage" min="0" max="100" step="0.1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Start Date:</label>
                                <input type="date" id="promotionStartDate">
                            </div>
                            <div class="form-group">
                                <label>End Date:</label>
                                <input type="date" id="promotionEndDate">
                            </div>
                            <div class="form-group">
                                <label>Description:</label>
                                <textarea id="promotionDescription" placeholder="Promotion description" rows="2"></textarea>
                            </div>
                        </div>
                        <button onclick="createPromotion()" class="btn-primary">Create Promotion</button>
                    </div>
                    <div id="promotionsTableDisplay"></div>
                </div>
            </div>

            <!-- User Management -->
            <div id="users" class="admin-tab-content">
                <div class="card">
                    <h2>User Management</h2>
                    <div class="user-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Username:</label>
                                <input type="text" id="newUsername" placeholder="Username">
                            </div>
                            <div class="form-group">
                                <label>Password:</label>
                                <input type="password" id="newPassword" placeholder="Password">
                            </div>
                            <div class="form-group">
                                <label>Role:</label>
                                <select id="newUserRole">
                                    <option value="sales">Sales</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Real Name:</label>
                                <input type="text" id="newUserRealName" placeholder="Real name">
                            </div>
                            <div class="form-group">
                                <label>Phone:</label>
                                <input type="text" id="newUserPhone" placeholder="Phone number">
                            </div>
                            <div class="form-group">
                                <label>Email:</label>
                                <input type="email" id="newUserEmail" placeholder="Email address">
                            </div>
                        </div>
                        <button onclick="addUser()" class="btn-primary">Add User</button>
                    </div>
                    <div id="usersTableDisplay"></div>
                </div>
            </div>

            <!-- Quotation Management -->
            <div id="quotations" class="admin-tab-content">
                <div class="card">
                    <h2>Quotation Management</h2>
                    <div id="allQuotationsList"></div>
                </div>
            </div>

            <!-- System Settings -->
            <div id="system" class="admin-tab-content">
                <div class="card">
                    <h2>System Settings</h2>
                    <div class="system-settings">
                        <div class="form-group">
                            <label>Company Name:</label>
                            <input type="text" id="companyName" placeholder="Company name">
                        </div>
                        <div class="form-group">
                            <label>Company Address:</label>
                            <input type="text" id="companyAddress" placeholder="Company address">
                        </div>
                        <div class="form-group">
                            <label>Company Phone:</label>
                            <input type="text" id="companyPhone" placeholder="Company phone">
                        </div>
                        <div class="form-group">
                            <label>Company Email:</label>
                            <input type="email" id="companyEmail" placeholder="Company email">
                        </div>
                        <div class="form-group">
                            <label>Payment Terms:</label>
                            <textarea id="paymentTerms" placeholder="Payment terms"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Additional Information:</label>
                            <textarea id="additionalInfo" placeholder="Additional company information"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Important Notes:</label>
                            <textarea id="importantNotes" placeholder="Important notes for quotations"></textarea>
                        </div>
                        <button onclick="saveSystemSettings()" class="btn-primary">Save Settings</button>
                        <button onclick="resetSystemSettings()" class="btn-danger" style="margin-left: 10px;">Reset to Default</button>
                    </div>
                </div>
            </div>

            <!-- 数据备份管理 -->
            <div id="backup" class="admin-tab-content">
                <div class="card">
                    <h2>数据备份管理</h2>
                    
                    <!-- 手动备份 -->
                    <div class="backup-section">
                        <h3>手动备份</h3>
                        <div class="backup-actions">
                            <button onclick="createFullBackup()" class="btn-primary">创建完整备份</button>
                            <button onclick="document.getElementById('restoreFileInput').click()" class="btn-secondary">从备份恢复</button>
                            <input type="file" id="restoreFileInput" accept=".json" style="display: none;" onchange="handleRestoreFile(this)">
                        </div>
                        <p class="backup-info">备份文件包含所有价格数据、配置信息和系统设置</p>
                    </div>

                    <!-- 自动备份配置 -->
                    <div class="backup-section">
                        <h3>自动备份配置</h3>
                        <div class="auto-backup-config">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>自动备份状态:</label>
                                    <span id="autoBackupStatus" class="status-text">未设置</span>
                                </div>
                                <div class="form-group">
                                    <label>备份间隔:</label>
                                    <span id="autoBackupInterval" class="status-text">未设置</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>上次备份:</label>
                                    <span id="lastBackupTime" class="status-text">从未</span>
                                </div>
                                <div class="form-group">
                                    <label>下次备份:</label>
                                    <span id="nextBackupTime" class="status-text">未设置</span>
                                </div>
                            </div>
                            <div class="backup-actions">
                                <button onclick="configureAutoBackup()" class="btn-primary">配置自动备份</button>
                                <button onclick="disableAutoBackup()" class="btn-danger">禁用自动备份</button>
                            </div>
                        </div>
                    </div>

                    <!-- 备份历史 -->
                    <div class="backup-section">
                        <h3>备份历史</h3>
                        <div class="backup-history">
                            <p>最近备份记录将显示在这里</p>
                            <div id="backupHistoryList"></div>
                        </div>
                    </div>

                    <!-- 备份说明 -->
                    <div class="backup-section">
                        <h3>备份说明</h3>
                        <div class="backup-notes">
                            <ul>
                                <li><strong>完整备份</strong>：包含所有价格数据、用户信息、配置设置等</li>
                                <li><strong>自动备份</strong>：可设置定时自动备份，确保数据安全</li>
                                <li><strong>备份恢复</strong>：可从备份文件完全恢复系统状态</li>
                                <li><strong>文件格式</strong>：备份文件为JSON格式，便于查看和编辑</li>
                                <li><strong>数据安全</strong>：建议定期备份并将备份文件保存在安全位置</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>

